<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chess Elo Guesser (CEG)</title>
    <link rel="icon" href="favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/chessground@8.4.0/assets/chessground.base.css"/>
    <link rel="stylesheet" href="https://unpkg.com/chessground@8.4.0/assets/chessground.cburnett.css"/>
    <link rel="stylesheet" href="https://unpkg.com/chessground@8.4.0/assets/chessground.brown.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="index.css">
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.0/dist/cyborg/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-4 text-center">
    <h3>Chess Elo Guesser (CEG)</h3><br>

    <div class="mt-0">
        <div class="input-group mb-3">
            <label for="pgn"></label><textarea maxlength="20000" type="text" id="pgn" class="form-control" name="pgn"
                                               placeholder="Enter PGN" rows="1"></textarea>
            <button class="btn btn-primary" id="pgn-button">GO</button>
        </div>
        <div class="my-3 fw-bold text-muted">OR</div>
        <div class="input-group mb-0">
            <label for="link"></label><input maxlength="20000" type="text" class="form-control" name="link" id="link"
                                             placeholder="Enter Lichess Link (e.g. https://lichess.org/gameid123/white)">
            <button class="btn btn-primary" id="link-button">GO</button>
        </div>

    </div>
    <hr>
    <div id="status" class="alert alert-primary" style="display: none"></div>
    <div class="collapse" id="collapse-container">
        <div id="box">
            <div id="board-container" tabindex="0">
                <div id="board" tabindex="0"></div>
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <span class="mt-3" id="move-counter">hi</span>
                    <div style="padding: 0; margin: 0; width: 70%; display: flex; justify-content: flex-end; gap: 5px;">
                        <a href="" target="_blank" rel="noopener" class="btn btn-primary board-btn"
                           id="export">Export</a>
                        <button type="button" class="btn btn-primary board-btn" id="flip-btn">
                            <i class="bi bi-arrow-repeat"></i>
                        </button>
                        <button type="button" class="btn btn-primary board-btn" id="end-btn">
                            <i class="bi bi-arrow-up"></i>
                        </button>
                        <button type="button" class="btn btn-primary board-btn" id="start-btn">
                            <i class="bi bi-arrow-down"></i>
                        </button>
                        <button type="button" class="btn btn-primary board-btn" id="prev-btn">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <button type="button" class="btn btn-primary board-btn" id="next-btn">
                            <i class="bi bi-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="charts">
                <canvas id="white-chart"></canvas>
                <br>
                <canvas id="black-chart"></canvas>
            </div>

        </div>
        <hr>
    </div>

    <div style="text-align: start">
        <h5>How to use:</h5>
        <ol>
            <li>Paste a PGN directly or enter a valid Lichess game URL in the input fields above.</li>
            <li>Press GO and wait for the server to respond.</li>
            <li>Use the buttons below the board to navigate through the moves, flip the board, or export the prediction
                data.
            </li>
            <li>The confidence charts show the model's certainty about the player's rating at each point in the game.
            </li>
        </ol>
        <p class="ms-2">
            This model does not search online for your rating or any external information except when you provide a
            Lichess link; In that case, it only uses the PGN of the game.<br><br>

            To avoid overlap with training data:
            All training data came from the <a href="https://database.lichess.org/" target="_blank" rel="noopener noreferrer">Lichess public database</a>.
            Most of the data comes from January 2025, with some additional data for rare brackets (e.g., <500 or
            >2800) pulled
            from parts of 2024 and January – June 2025. To avoid potential overlap with the training data, please avoid
            using games played between July 2024 and July 2025 (inclusive).
        </p>
        <h5>What do the outputs mean?:</h5>
        <p class="ms-2">
            <strong>Elo Confidence Charts:</strong><br>
            The charts show the model’s estimated probability distribution over different Elo rating brackets for
            each
            player as the game progresses. The height of each bar or curve shows the model’s confidence that the
            player’s rating falls between the label or the label + 100 at a given move. For example, if the bar for 1500
            is 0.2, then that
            means the model is 20% confident the player's rating is between 1500 and 1600. Watching the chart live shows
            how the model’s confidence changes based on the moves played.
        </p>
        <p class="ms-2">
            <strong>Point Estimate:</strong><br>
            The model provides a single Elo rating estimate for each player at every move.
            This point estimate is calculated by finding the rating value that best fits the predicted probability
            distribution, minimizing the difference between the model’s output and a smooth normal distribution centered
            at that rating. You can interpret it as the model's best guess of the player's skill at that moment.</p>

        <hr>
        <h4 style="text-align: center;">Stuff for nerds:</h4><br>
        <h5>Data and Training</h5>
        <ul>
            <li>The training data consisted of 2,451,672 blitz games, filtered to include only "Rated Blitz" games with
                >10
                half-moves.
            </li>
            <li>Games were balanced across Elo brackets such that the ratio between the most and least common
                classes is less than 4:1.
            </li>
            <li>Most data comes from June 2025, with additional months used for rare rating brackets.</li>
            <li>Because of the slowness of Python, games were filtered and parsed via Java/Kotlin into an
                intermediate format.
            </li>
        </ul>
        <h5>Labels</h5>
        <p class="ms-2">
            Each game's Elo was converted into a soft target using a normal distribution centered on the true Elo (σ =
            200), and integrated across output brackets.
        </p>
        <ul>
            <li>Training was done for just over 7 epochs with batch size 64.</li>
            <li>Loss was calculated using Kullback-Leibler loss across all time-steps.</li>
        </ul>
        <canvas id="loss-chart"></canvas>

        <br>
        <h5>Architecture</h5>
        <p class="ms-2">
            Each board "frame" is turned into an embedding in the following process:
        </p>
        <ol>
            <li>For each square, a learned piece embedding is summed with a learned square embedding.</li>
            <li>Special learned embeddings are added to the <i>from</i> and <i>to</i> squares for each move. If the move
                is a promotion, a separate promotion embedding is added to the <i>to</i> square.
            </li>
            <li> The resulting board representation is passed through a Convolutional Neural Network (CNN) to capture
                spatial patterns.
            </li>
        </ol>
        <p class="ms-2">
            These embeddings are then alternatingly routed (for example: [1,2,3, 4] -> [1,3], [2, 4]) into two LSTM
            networks (one for White, one for Black). (See full architecture in the source code. File is named net.py)
        </p>
        <p class="ms-2">
            This CNN-LSTM architecture was chosen because it offered significantly faster inference relative to
            transformer models, and uses CNN strengths for spatial pattern recognition. </p>
        <p class="ms-2">
            To compute the point estimate, the model finds the value of \(x\) that minimizes the mean squared error
            between a normal distribution (mean=\(x\), \(\sigma\)=200) integrated over Elo brackets and the models
            predicted distribution.</p>

        <img src="architecture.svg" class="img-fluid" alt="architecture" style="margin: 0px; width: 110%;">
        <br>
        <br>
        <br>
        <br>
        <h5>Performance Metrics</h5>
        <ul>
            <li>The model was evaluated on 10,000 unseen games with >30 half moves.</li>
            <li>It achieved an R<sup>2</sup> of 0.86, which means there is a strong correlation between predicted and
                actual elo.
            </li>
            <li>It achieved an R-MSE of 277.
            </li>
        </ul>
        <canvas id="scatter-chart"></canvas>
        <br>
        <h5>For people doing something similar:</h5>
        <p class="ms-2"><strong>What worked well:</strong></p>
        <ul>
            <li>Using a Convolutional Neural Network to analyze board positions.</li>
            <li>Using an LSTM allows for move by move evaluations.</li>
            <li>Using separate LSTMs for each player.</li>
            <li>Using soft targets in the form of KL-Divergence loss.</li>
        </ul>
        <p class="ms-2"><strong>What to avoid:</strong></p>
        <ul>
            <li>Using only the move sequence instead of board images. Doing this resulted in significantly worse
                performance.
            </li>
            <li>Using hard targets such as cross-entropy loss. This resulted in the model taking a very long time to
                converge.
            </li>
            <li>Using a single point target such as MSE. This resulted in the model tending to predict the means of the
                outputs instead of actually learning anything.
            </li>
            <li>Using a single LSTM. This resulted in the model tending to predict the same distribution for both
                players.
            </li>
        </ul>
        <p class="ms-2"><strong>Things to try:</strong></p>
        <ul>
            <li>Expanding labels beyond 400–3000 so that distributions on the edge are not skewed.</li>
            <li>Because Lichess games are capped at 300 half moves, a transformer could possibly be used to output a
                final distribution for all games.
            </li>
            <li>Using a different distribution for the target rather than normally distributed. A static normal distribution was chosen
                for simplicity (also because that is how the Elo model was defined), however, most modern chess elo models (such as what Lichess uses) actually use different distributions.
            </li>
        </ul>

        <h5>Limitations</h5>
        <ul>
            <li><strong>Time controls/Variants: </strong>This model was trained only on standard blitz, therefore
                the model's outputs for bullet, rapid,
                classical, or any variant may be unreliable.
            </li>
            <li><strong>Hyperparameter tuning: </strong>Parameters were determined using random sampling rather than
                more
                rigorous search, so further optimization is likely possible.
            </li>
        </ul>
        <h5>Future Work</h5>
        <ol>
            <li>Possibly expanding to other time controls.
            </li>
            <li>Releasing a lighter model for lower resource usage.</li>
            <li>Releasing a heavier model to reduce R-MSE closer to the lower bound.</li>
        </ol>
        <h5>Tech Stack</h5>
        <p class="ms-2">
            Languages: Python 3.12.3, Java, Kotlin, JavaScript, HTML/CSS<br>
            Frameworks & Libraries: PyTorch, Flask, MessagePack, bhlangonijr/chesslib, python-chess, ChessGround<br>
            Tools: IntelliJ, PyCharm, WebStorm<br>
            See full attributions on GitHub
        </p>
        <h5>Links: </h5>
        <a href="https://github.com/gliucode/chess-elo-guesser" target="_blank" class="btn btn-dark" rel="noopener noreferrer"
           style="background-color: #a3a3a3">
            <i class="fab fa-github me-2"></i> View on GitHub
        </a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"
        integrity="sha512-xRllwz2gdZciIB+AkEbeq+gVhX8VB8XsfqeFbUh+SzHlN96dEduwtTuVuc2u9EROlmW9+yhRlxjif66ORpsgVA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="module" src="index.js"></script>
<script type="module" src="tables.js"></script>
<script>
    const textarea = document.getElementById('pgn');

    function autoResize() {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    textarea.addEventListener('input', autoResize);
    autoResize();
</script>

</body>

</html>